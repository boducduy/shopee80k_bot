<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·∫∑t Voucher Shopee</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: var(--tg-theme-bg-color, #fff1f2);
            color: var(--tg-theme-text-color, #000000);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .shopee-orange {
            background-color: #ee4d2d;
        }
        .input-field {
            @apply mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md text-sm shadow-sm placeholder-gray-400
            focus:outline-none focus:border-orange-500 focus:ring-1 focus:ring-orange-500;
        }
        .section-title {
            @apply block text-sm font-medium text-gray-700 mb-1;
        }
    </style>
</head>
<body class="min-h-screen py-4 px-3">

    <div class="max-w-md mx-auto space-y-4 bg-white p-5 rounded-xl shadow-lg border-t-4 border-[#ee4d2d]">
        
        <div class="text-center">
            <h2 class="text-xl font-bold text-gray-900 uppercase">üì¶ L√™n ƒê∆°n Voucher</h2>
            <p class="mt-1 text-xs text-gray-500">Nh·∫≠p th√¥ng tin ƒë·ªÉ Bot x·ª≠ l√Ω t·ª± ƒë·ªông</p>
        </div>

        <form id="orderForm" class="space-y-4">
            
            <div>
                <label class="section-title">1. Link S·∫£n Ph·∫©m <span class="text-red-500">*</span></label>
                <input type="url" id="productLink" required class="input-field" placeholder="D√°n link Shopee v√†o ƒë√¢y...">
            </div>

            <div>
                <label class="section-title">2. T√™n SP</label>
                <input type="text" id="productName" class="input-field" placeholder="V√≠ d·ª•: √Åo thun ƒëen...">
            </div>

            <div>
                <label class="section-title">3. Ph√¢n lo·∫°i (M√†u/Size)</label>
                <input type="text" id="variant" class="input-field" placeholder="Xanh, Size L">
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="section-title">4. Gi√° g·ªëc (ƒë)</label>
                    <input type="text" id="price" class="input-field text-right" placeholder="0" oninput="formatCurrencyInput(this)">
                </div>
                <div>
                    <label class="section-title">S·ªë l∆∞·ª£ng</label>
                    <input type="number" id="quantity" value="1" min="1" class="input-field text-center">
                </div>
            </div>

            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                <label class="section-title text-orange-600 mb-2">5. ƒê·ªãa ch·ªâ nh·∫≠n h√†ng <span class="text-red-500">*</span></label>
                <div class="space-y-2">
                    <select id="province" class="input-field" required></select>
                    <select id="district" class="input-field" required disabled></select>
                    <select id="ward" class="input-field" required disabled></select>
                    <input type="text" id="addressDetail" required class="input-field" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng...">
                </div>
            </div>

            <div>
                <label class="section-title">6. Ghi ch√∫</label>
                <textarea id="note" rows="2" class="input-field" placeholder="Ghi ch√∫ th√™m..."></textarea>
            </div>

            <div class="pt-2"></div>
        </form>
    </div>

    <div class="h-20"></div>

    <script>
        // --- KH·ªûI T·∫†O TELEGRAM WEB APP ---
        const tg = window.Telegram.WebApp;
        tg.expand(); // M·ªü r·ªông full m√†n h√¨nh

        // C·∫•u h√¨nh n√∫t ch√≠nh (MainButton) c·ªßa Telegram
        tg.MainButton.text = "G·ª¨I ƒê∆†N NGAY";
        tg.MainButton.color = "#ee4d2d"; // M√†u cam Shopee
        tg.MainButton.textColor = "#ffffff";
        tg.MainButton.show();

        // --- LOGIC X·ª¨ L√ù FORM ---
        const priceInput = document.getElementById('price');
        
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function formatCurrencyInput(input) {
            let value = input.value.replace(/\D/g, '');
            input.value = formatNumber(value);
        }

        // --- API ƒê·ªäA CH√çNH (Gi·ªØ nguy√™n logic c·ªßa b·∫°n) ---
        const provinceSelect = document.getElementById('province');
        const districtSelect = document.getElementById('district');
        const wardSelect = document.getElementById('ward');

        async function fetchLocations() {
            try {
                const response = await fetch('https://esgoo.net/api-tinhthanh/1/0.htm');
                const data = await response.json();
                if (data.error === 0) {
                    provinceSelect.innerHTML = '<option value="">T·ªânh/Th√†nh ph·ªë</option>';
                    data.data.forEach(p => {
                        const opt = document.createElement('option');
                        opt.value = p.id;
                        opt.textContent = p.full_name;
                        provinceSelect.appendChild(opt);
                    });
                }
            } catch (e) {}
        }

        provinceSelect.addEventListener('change', async function() {
            const id = this.value;
            districtSelect.innerHTML = '<option value="">Qu·∫≠n/Huy·ªán</option>';
            wardSelect.innerHTML = '<option value="">Ph∆∞·ªùng/X√£</option>';
            districtSelect.disabled = true; wardSelect.disabled = true;
            if(id){
                const res = await fetch(`https://esgoo.net/api-tinhthanh/2/${id}.htm`);
                const d = await res.json();
                if(d.error===0){
                    d.data.forEach(x => {
                        const opt = document.createElement('option');
                        opt.value = x.id; opt.textContent = x.full_name;
                        districtSelect.appendChild(opt);
                    });
                    districtSelect.disabled=false;
                }
            }
        });

        districtSelect.addEventListener('change', async function() {
            const id = this.value;
            wardSelect.innerHTML = '<option value="">Ph∆∞·ªùng/X√£</option>';
            wardSelect.disabled = true;
            if(id){
                const res = await fetch(`https://esgoo.net/api-tinhthanh/3/${id}.htm`);
                const d = await res.json();
                if(d.error===0){
                    d.data.forEach(x => {
                        const opt = document.createElement('option');
                        opt.value = x.id; opt.textContent = x.full_name;
                        wardSelect.appendChild(opt);
                    });
                    wardSelect.disabled=false;
                }
            }
        });

        window.addEventListener('DOMContentLoaded', fetchLocations);

        // --- G·ª¨I D·ªÆ LI·ªÜU V·ªÄ BOT ---
        Telegram.WebApp.onEvent('mainButtonClicked', function(){
            // Validate d·ªØ li·ªáu
            const link = document.getElementById('productLink').value;
            const pName = provinceSelect.options[provinceSelect.selectedIndex]?.text;
            const dName = districtSelect.options[districtSelect.selectedIndex]?.text;
            const wName = wardSelect.options[wardSelect.selectedIndex]?.text;
            const detail = document.getElementById('addressDetail').value;

            if(!link || !detail || provinceSelect.value == "" || districtSelect.value == "" || wardSelect.value == "") {
                tg.showAlert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß Link v√† ƒê·ªãa ch·ªâ!");
                return;
            }

            const productName = document.getElementById('productName').value || "Kh√¥ng t√™n";
            const variant = document.getElementById('variant').value || "Ng·∫´u nhi√™n";
            const note = document.getElementById('note').value || "";
            
            // T·∫°o chu·ªói ƒë·ªãa ch·ªâ ƒë·∫ßy ƒë·ªß
            const fullAddress = `${detail}, ${wName}, ${dName}, ${pName}`;
            
            // T·∫°o object d·ªØ li·ªáu ƒë·ªÉ g·ª≠i v·ªÅ Python
            // C·∫•u tr√∫c n√†y kh·ªõp v·ªõi logic bot Python: data.get('code'), data.get('link')...
            const dataToSend = {
                link: link,
                code: `${productName} (${variant})`, // G·ªôp t√™n v√† ph√¢n lo·∫°i v√†o code
                quantity: document.getElementById('quantity').value,
                price_original: priceInput.value, // G·ª≠i ƒë·ªÉ tham kh·∫£o (Bot t·ª± t√≠nh gi√° config)
                address: fullAddress,
                note: note
            };

            // G·ª≠i d·ªØ li·ªáu v·ªÅ Bot
            tg.sendData(JSON.stringify(dataToSend));
        });

    </script>
</body>
</html>
