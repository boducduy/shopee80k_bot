<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·∫∑t Voucher Shopee</title>
    <!-- SDK Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Th∆∞ vi·ªán TomSelect ƒë·ªÉ t√¨m ki·∫øm trong th·∫ª Select -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <style>
        body { 
            background-color: #f3f4f6; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding-bottom: 100px;
        }
        
        .input-field {
            @apply mt-2 block w-full px-4 py-3 bg-white border border-gray-300 rounded-lg text-base text-gray-900 
            focus:outline-none focus:border-orange-500 focus:ring-2 focus:ring-orange-200 transition-all;
        }
        
        .section-title {
            @apply block text-base font-bold text-gray-800 mb-1;
        }
        
        .input-icon {
            @apply absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400;
        }

        .voucher-option:checked + div {
            border-color: #ee4d2d;
            background-color: #fff1f0;
            box-shadow: 0 4px 6px -1px rgba(238, 77, 45, 0.1), 0 2px 4px -1px rgba(238, 77, 45, 0.06);
        }
        .voucher-option:checked + div .check-icon {
            opacity: 1;
        }
        
        .price-display {
            font-size: 1.1em;
            font-weight: 800;
            margin-left: 8px;
            color: #fff;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 6px;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* T√πy ch·ªânh CSS cho TomSelect ƒë·ªÉ kh·ªõp giao di·ªán */
        .ts-control {
            border-radius: 0.5rem !important;
            padding: 0.75rem 1rem !important;
            border-color: #d1d5db !important;
            font-size: 1rem !important;
        }
        .ts-control.focus {
            border-color: #f97316 !important; /* orange-500 */
            box-shadow: 0 0 0 2px #fed7aa !important; /* orange-200 ring */
        }
        .ts-dropdown {
            border-radius: 0.5rem !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
            z-index: 50 !important;
        }
    </style>
</head>
<body class="min-h-screen py-8 px-4 flex justify-center items-start">

    <!-- Container ch√≠nh -->
    <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl overflow-hidden border border-gray-100">
        
        <!-- Header -->
        <div class="bg-gradient-to-r from-orange-500 to-red-500 p-6 text-center text-white relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-white opacity-5 transform -skew-x-12"></div>
            <h2 class="text-2xl md:text-3xl font-extrabold uppercase tracking-wide relative z-10">üì¶ ƒê∆°n ƒê·∫∑t H√†ng</h2>
            <p class="text-orange-100 text-sm mt-1 relative z-10">Ch·ªçn lo·∫°i Voucher v√† ƒëi·ªÅn th√¥ng tin b√™n d∆∞·ªõi</p>
        </div>

        <form id="orderForm" class="p-6 space-y-6">
            
            <!-- 0. CH·ªåN LO·∫†I VOUCHER -->
            <div class="bg-orange-5 border border-orange-100 rounded-xl p-4">
                <label class="section-title text-orange-800 mb-3 flex items-center">
                    <i class="fas fa-ticket-alt mr-2 text-orange-600"></i> Ch·ªçn lo·∫°i Voucher <span class="text-red-500 ml-1">*</span>
                </label>
                <div class="grid grid-cols-3 gap-2">
                    <!-- Option 60k -->
                    <label class="cursor-pointer relative group">
                        <input type="radio" name="voucherType" value="60k" class="voucher-option sr-only" onchange="updatePrice()">
                        <div class="border-2 border-gray-200 rounded-xl p-2 text-center transition-all h-full flex flex-col justify-center items-center relative bg-white group-hover:border-orange-200">
                            <span class="font-bold text-gray-800 text-sm md:text-base">Voucher 60k</span>
                            <div class="text-xs md:text-sm text-gray-500 mt-1" id="labelPrice60">20k/l∆∞·ª£t</div>
                            <i class="fas fa-check-circle check-icon absolute top-1 right-1 text-orange-500 opacity-0 transition-opacity text-base"></i>
                        </div>
                    </label>

                    <!-- Option 80k -->
                    <label class="cursor-pointer relative group">
                        <input type="radio" name="voucherType" value="80k" class="voucher-option sr-only" checked onchange="updatePrice()">
                        <div class="border-2 border-gray-200 rounded-xl p-2 text-center transition-all h-full flex flex-col justify-center items-center relative bg-white group-hover:border-orange-200">
                            <span class="font-bold text-gray-800 text-sm md:text-base">Voucher 80k</span>
                             <div class="text-xs md:text-sm text-gray-500 mt-1" id="labelPrice80">26k/l∆∞·ª£t</div>
                            <i class="fas fa-check-circle check-icon absolute top-1 right-1 text-orange-500 opacity-0 transition-opacity text-base"></i>
                        </div>
                    </label>

                    <!-- Option 100k -->
                    <label class="cursor-pointer relative group">
                        <input type="radio" name="voucherType" value="100k" class="voucher-option sr-only" onchange="updatePrice()">
                        <div class="border-2 border-gray-200 rounded-xl p-2 text-center transition-all h-full flex flex-col justify-center items-center relative bg-white group-hover:border-orange-200">
                            <span class="font-bold text-gray-800 text-sm md:text-base">Voucher 100k</span>
                             <div class="text-xs md:text-sm text-gray-500 mt-1" id="labelPrice100">30k/l∆∞·ª£t</div>
                            <i class="fas fa-check-circle check-icon absolute top-1 right-1 text-orange-500 opacity-0 transition-opacity text-base"></i>
                        </div>
                    </label>
                </div>
            </div>

            <!-- 1. Link S·∫£n Ph·∫©m -->
            <div>
                <label class="section-title flex justify-between items-center">
                    <span>1. Link S·∫£n Ph·∫©m <span class="text-red-500">*</span></span>
                </label>
                <div id="linkContainer">
                    <div class="relative mb-3">
                        <div class="input-icon"><i class="fas fa-link"></i></div>
                        <input type="url" name="productLink" required class="input-field pl-12" placeholder="D√°n link Shopee s·ªë 1...">
                    </div>
                </div>
                <button type="button" id="addLinkBtn" class="text-sm font-semibold text-orange-600 bg-orange-50 hover:bg-orange-100 px-4 py-2 rounded-lg transition-colors flex items-center">
                    <i class="fas fa-plus-circle mr-2"></i> Th√™m link s·∫£n ph·∫©m kh√°c
                </button>
            </div>

            <!-- 2.T√™n+S·ªë ƒëi·ªán tho·∫°i -->
            <div>
                <label class="section-title">2. T√™n + S·ªë ƒëi·ªán tho·∫°i <span class="text-gray-400 font-normal text-sm ml-1">(QUEN SHIP B·ªé QUA)</span></label>
                <div class="relative">
                    <div class="input-icon"><i class="fas fa-address-book"></i></div>
                    <input type="text" id="phoneNumber" class="input-field pl-12" placeholder="V√≠ d·ª•: N Nam(091,234,5678)">
                </div>
            </div>

            <!-- 3. T√™n SP -->
            <div>
                <label class="section-title">3. T√™n S·∫£n Ph·∫©m</label>
                <div class="relative">
                    <div class="input-icon"><i class="fas fa-box-open"></i></div>
                    <input type="text" id="productName" class="input-field pl-12" placeholder="V√≠ d·ª•: √Åo thun ƒëen, Gi√†y size 40...">
                </div>
            </div>

            <!-- H√†ng ngang: Ph√¢n lo·∫°i & S·ªë l∆∞·ª£ng -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- 4. Ph√¢n lo·∫°i -->
                <div>
                    <label class="section-title">4. Ph√¢n lo·∫°i <span class="text-red-500">*</span></label>
                    <div class="relative">
                        <div class="input-icon"><i class="fas fa-list-ul"></i></div>
                        <input type="text" id="variant" required class="input-field pl-12" placeholder="M√†u, Size (GHI R√ï)">
                    </div>
                </div>

                <!-- 5. S·ªë l∆∞·ª£ng -->
                <div>
                    <label class="section-title">5. S·ªë l∆∞·ª£ng</label>
                    <div class="relative">
                        <div class="input-icon"><i class="fas fa-sort-numeric-up"></i></div>
                        <input type="number" id="quantity" value="1" min="1" class="input-field pl-12 font-bold text-center">
                    </div>
                </div>
            </div>

            <!-- 6. Ghi ch√∫ -->
            <div>
                <label class="section-title">6. Ghi ch√∫</label>
                <div class="relative">
                    <div class="absolute top-4 left-0 pl-4 flex items-center pointer-events-none text-gray-400"><i class="fas fa-pen"></i></div>
                    <textarea id="note" rows="2" class="input-field pl-12" placeholder="Ghi ch√∫ th√™m cho admin..."></textarea>
                </div>
            </div>

            <!-- 7. ƒê·ªãa ch·ªâ nh·∫≠n h√†ng (T√¨m ki·∫øm ƒë∆∞·ª£c) -->
            <div class="bg-gray-50 border border-gray-200 rounded-xl p-5">
                <label class="section-title text-gray-700 mb-3 flex items-center">
                    <i class="fas fa-map-marker-alt mr-2 text-red-500"></i> 7. ƒê·ªãa ch·ªâ nh·∫≠n h√†ng <span class="text-red-500 ml-1">*</span>
                </label>
                
                <div class="space-y-4">
                    <!-- T·ªânh/Th√†nh -->
                    <div>
                        <select id="province" class="input-field w-full" required>
                            <option value="">Ch·ªçn T·ªânh/Th√†nh ph·ªë</option>
                        </select>
                    </div>

                    <!-- Qu·∫≠n/Huy·ªán -->
                    <div>
                        <select id="district" class="input-field w-full" required disabled>
                            <option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>
                        </select>
                    </div>

                    <!-- Ph∆∞·ªùng/X√£ -->
                    <div>
                        <select id="ward" class="input-field w-full" required disabled>
                            <option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>
                        </select>
                    </div>

                    <!-- ƒê·ªãa ch·ªâ chi ti·∫øt (ƒê√£ b·ªè g·ª£i √Ω, quay v·ªÅ input th∆∞·ªùng) -->
                    <input type="text" id="addressDetail" required class="input-field" placeholder="S·ªë nh√†, t√™n ƒë∆∞·ªùng c·ª• th·ªÉ...">
                </div>
            </div>

            <!-- L∆∞u √Ω nh·ªè -->
            <div class="flex items-start gap-2 text-sm text-amber-600 bg-amber-50 p-3 rounded-lg border border-amber-100">
                <i class="fas fa-info-circle mt-1"></i>
                <span>L∆∞u √Ω: N·∫øu c√≥ nhi·ªÅu link, shop s·∫Ω chia ra t·ª´ng ƒë∆°n. M·ªói ƒë∆°n ship s·∫Ω l√† 1k.</span>
            </div>

            <!-- N√öT G·ª¨I (Fixed Bottom) -->
            <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50">
                <div class="max-w-lg mx-auto">
                    <!-- N√∫t G·ª≠i hi·ªÉn th·ªã gi√° ti·ªÅn -->
                    <button type="submit" id="submitBtn" class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-700 hover:to-red-700 text-white font-bold py-3.5 px-6 rounded-xl shadow-lg transform transition hover:scale-[1.01] active:scale-95 flex justify-center items-center text-lg">
                        <span>G·ª¨I ƒê∆†N H√ÄNG</span>
                        <span id="btnPriceDisplay" class="price-display">26.000ƒë</span>
                    </button>
                </div>
            </div>

        </form>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();

        // --- C·∫§U H√åNH GI√Å ---
        let PRICE_60K = 20000;
        let PRICE_80K = 26000;
        let PRICE_100K = 30000;

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('v60')) PRICE_60K = parseInt(urlParams.get('v60'));
        if (urlParams.has('v80')) PRICE_80K = parseInt(urlParams.get('v80'));
        if (urlParams.has('v100')) PRICE_100K = parseInt(urlParams.get('v100'));

        document.getElementById('labelPrice60').innerText = new Intl.NumberFormat('vi-VN').format(PRICE_60K) + 'ƒë/l∆∞·ª£t';
        document.getElementById('labelPrice80').innerText = new Intl.NumberFormat('vi-VN').format(PRICE_80K) + 'ƒë/l∆∞·ª£t';
        document.getElementById('labelPrice100').innerText = new Intl.NumberFormat('vi-VN').format(PRICE_100K) + 'ƒë/l∆∞·ª£t';

        function updatePrice() {
            const voucherType = document.querySelector('input[name="voucherType"]:checked').value;
            let finalPrice = (voucherType === '60k') ? PRICE_60K : (voucherType === '80k' ? PRICE_80K : PRICE_100K);
            document.getElementById('btnPriceDisplay').innerText = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(finalPrice);
        }
        updatePrice();


        // --- X·ª¨ L√ù TH√äM LINK ---
        document.getElementById('addLinkBtn').addEventListener('click', function() {
            const container = document.getElementById('linkContainer');
            const count = container.children.length + 1;
            const div = document.createElement('div');
            div.className = 'relative mb-3 fade-in flex items-center gap-2';
            div.innerHTML = `
                <div class="relative w-full">
                    <div class="input-icon"><i class="fas fa-link"></i></div>
                    <input type="url" name="productLink" class="input-field pl-12 mt-0" placeholder="D√°n link Shopee s·ªë ${count}...">
                </div>
                <button type="button" class="text-gray-400 hover:text-red-500 p-2 rounded-full hover:bg-red-50 transition-colors" onclick="removeLink(this)">
                    <i class="fas fa-trash-alt"></i>
                </button>
            `;
            container.appendChild(div);
        });

        function removeLink(btn) {
            btn.parentElement.remove();
        }

        // --- KH·ªûI T·∫†O TOM SELECT & API ƒê·ªäA CH√çNH ---
        // Bi·∫øn l∆∞u tr·ªØ instance c·ªßa TomSelect ƒë·ªÉ thao t√°c ƒë·ªông (clear/add options)
        let tomProvince, tomDistrict, tomWard;

        // C·∫•u h√¨nh chung cho TomSelect
        const tomConfig = {
            create: false,
            sortField: { field: "text", direction: "asc" },
            placeholder: "Ch·ªçn...", // ƒê√£ x√≥a "T√¨m ki·∫øm ho·∫∑c"
            plugins: ['no_active_items'], // Kh√¥ng auto-select item ƒë·∫ßu ti√™n
            maxOptions: null // Hi·ªÉn th·ªã t·∫•t c·∫£
        };

        // H√†m kh·ªüi t·∫°o
        function initSelects() {
            // ƒê√£ x√≥a t·ª´ "tr∆∞·ªõc" trong c√°c placeholder b√™n d∆∞·ªõi
            tomProvince = new TomSelect('#province', tomConfig);
            tomDistrict = new TomSelect('#district', { ...tomConfig, placeholder: "Ch·ªçn T·ªânh/Th√†nh ph·ªë..." });
            tomWard = new TomSelect('#ward', { ...tomConfig, placeholder: "Ch·ªçn Qu·∫≠n/Huy·ªán..." });
            
            // Kh√≥a District/Ward l√∫c ƒë·∫ßu
            tomDistrict.disable();
            tomWard.disable();
        }

        async function fetchLocations() {
            try {
                // Load T·ªânh/Th√†nh
                const res = await fetch('https://esgoo.net/api-tinhthanh/1/0.htm');
                const data = await res.json();
                if(data.error===0) {
                    // Th√™m data v√†o TomSelect Province
                    tomProvince.clearOptions();
                    data.data.forEach(p => {
                        tomProvince.addOption({value: p.id, text: p.full_name});
                    });
                    // Refresh l·∫°i UI
                    tomProvince.sync();
                }
            } catch(e) { console.error(e); }
        }

        // S·ª± ki·ªán khi ch·ªçn T·ªânh/Th√†nh
        // TomSelect ·∫©n select g·ªëc, nh∆∞ng ta c√≥ th·ªÉ listen event tr√™n TomSelect instance ho·∫∑c select g·ªëc (n·∫øu sync t·ªët)
        // D√πng 'change' tr√™n select g·ªëc v·∫´n ho·∫°t ƒë·ªông v·ªõi TomSelect
        document.getElementById('province').addEventListener('change', async function() {
            const idProvince = this.value;
            
            // Reset District & Ward
            tomDistrict.clear();
            tomDistrict.clearOptions();
            tomDistrict.disable();
            tomDistrict.settings.placeholder = "ƒêang t·∫£i...";
            tomDistrict.sync();

            tomWard.clear();
            tomWard.clearOptions();
            tomWard.disable();
            tomWard.sync();

            if(!idProvince) return;

            // Fetch Qu·∫≠n/Huy·ªán
            try {
                const res = await fetch(`https://esgoo.net/api-tinhthanh/2/${idProvince}.htm`);
                const d = await res.json();
                if(d.error===0) {
                    d.data.forEach(x => {
                        tomDistrict.addOption({value: x.id, text: x.full_name});
                    });
                    tomDistrict.settings.placeholder = "Ch·ªçn Qu·∫≠n/Huy·ªán";
                    tomDistrict.enable();
                    tomDistrict.sync();
                }
            } catch(e){}
        });

        // S·ª± ki·ªán khi ch·ªçn Qu·∫≠n/Huy·ªán
        document.getElementById('district').addEventListener('change', async function() {
            const idDistrict = this.value;
            
            // Reset Ward
            tomWard.clear();
            tomWard.clearOptions();
            tomWard.disable();
            tomWard.settings.placeholder = "ƒêang t·∫£i...";
            tomWard.sync();

            if(!idDistrict) return;

            // Fetch Ph∆∞·ªùng/X√£
            try {
                const res = await fetch(`https://esgoo.net/api-tinhthanh/3/${idDistrict}.htm`);
                const d = await res.json();
                if(d.error===0) {
                    d.data.forEach(x => {
                        tomWard.addOption({value: x.id, text: x.full_name});
                    });
                    tomWard.settings.placeholder = "Ch·ªçn Ph∆∞·ªùng/X√£";
                    tomWard.enable();
                    tomWard.sync();
                }
            } catch(e){}
        });

        // Ch·∫°y khi load trang
        window.onload = () => {
            initSelects();
            fetchLocations();
        };

        // --- X·ª¨ L√ù G·ª¨I D·ªÆ LI·ªÜU ---
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const voucherType = document.querySelector('input[name="voucherType"]:checked').value;
            const linkInputs = document.querySelectorAll('input[name="productLink"]');
            const links = Array.from(linkInputs).map(i => i.value.trim()).filter(v => v !== '').join('\n');

            if (!links) {
                tg.showAlert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t 1 link s·∫£n ph·∫©m!");
                return;
            }

            // L·∫•y text t·ª´ TomSelect (ho·∫∑c select g·ªëc)
            // Khi d√πng TomSelect, value c·ªßa select g·ªëc ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t
            const pVal = document.getElementById('province').value;
            const dVal = document.getElementById('district').value;
            const wVal = document.getElementById('ward').value;

            if (!pVal || !dVal || !wVal) {
                 tg.showAlert("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß ƒë·ªãa ch·ªâ!");
                 return;
            }

            // ƒê·ªÉ l·∫•y Text hi·ªÉn th·ªã (T√™n t·ªânh), ta l·∫•y t·ª´ options c·ªßa TomSelect
            const pName = tomProvince.options[pVal]?.text || "";
            const dName = tomDistrict.options[dVal]?.text || "";
            const wName = tomWard.options[wVal]?.text || "";

            const fullAddress = `${document.getElementById('addressDetail').value}, ${wName}, ${dName}, ${pName}`;

            const data = {
                voucherType: voucherType,
                link: links,              
                phone: document.getElementById('phoneNumber').value || "---",
                code: document.getElementById('productName').value || "---",
                variant: document.getElementById('variant').value,
                quantity: document.getElementById('quantity').value, 
                address: fullAddress,
                note: document.getElementById('note').value
            };

            tg.sendData(JSON.stringify(data));
        });
    </script>
</body>
</html>
